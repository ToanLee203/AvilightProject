@page
@model AnviLightCode.Pages.User.CartModel
@using AnviLightCode.Models
@{
    var cartItems = Model.CartItems;
}

<section id="cart" class="py-5 my-5 leaf-pattern-overlay">
    <div class="corner-pattern-overlay"></div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12">
                <div class="section-header align-center">
                    <div class="title">
                        <span>Đơn hàng của bạn</span>
                    </div>
                    <h2 class="section-title">Giỏ hàng</h2>
                </div>

                @if (cartItems == null || !cartItems.Any())
                {
                    <div class="cart-empty text-center">
                        <p>Giỏ hàng của bạn đang trống.</p>
                        <div class="btn-wrap">
                            <a href="/" class="btn btn-outline-accent btn-accent-arrow">
                                Tiếp tục mua sắm <i class="icon icon-ns-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                }
                else
                {
                    <div class="cart-items">
                        <div class="row">
                            <div class="col-md-8">
                                @foreach (var item in cartItems)
                                {
                                    var variant = item.BienTheSanPham;
                                    var productName = variant?.SanPham?.TenSanPham ?? "Sản phẩm";

                                    // Ví dụ: tạo tên biến thể bằng cách nối màu sắc + kích thước
                                    var variantDetails = "";
                                    if (variant != null)
                                    {
                                        variantDetails = $"{variant.MauSac?.TenMauSac ?? ""} - {variant.KichThuoc?.TenKichThuoc ?? ""}".Trim(' ', '-');
                                    }

                                    // Lấy ảnh: ưu tiên ảnh biến thể nếu có, không thì ảnh sản phẩm, không có thì ảnh mặc định
                                    var imageUrl = variant?.SanPham?.HinhAnh ?? "~/stylecommon/images/default-product.jpg";

                                    var price = variant?.Gia ?? 0;

                                    <div class="cart-item mb-4 border-bottom pb-4">
                                        <div class="row align-items-center">
                                            <!-- Hình ảnh -->
                                            <div class="col-md-2 col-3">
                                                <img src="@imageUrl" alt="@productName" class="img-fluid" />
                                            </div>
                                            <!-- Thông tin sản phẩm -->
                                            <div class="col-md-5 col-9">
                                                <h3 class="item-title mb-2">@productName</h3>
                                                <p class="mb-1">Biến thể: @variantDetails</p>
                                                <a asp-page-handler="RemoveItem" asp-route-id="@item.Id" class="text-muted small">Xóa</a>
                                            </div>
                                            <!-- Số lượng -->
                                            <div class="col-md-3 col-6">
                                                <form method="post" asp-page-handler="UpdateQuantity" class="d-flex align-items-center">
                                                    <input type="hidden" name="CartItemId" value="@item.Id" />
                                                    <button type="submit" name="action" value="decrease" class="btn btn-outline-dark btn-small">-</button>
                                                    <input type="number" name="Quantity" value="@item.Quantity" min="1" class="form-control mx-2 text-center" style="width: 60px;" />
                                                    <button type="submit" name="action" value="increase" class="btn btn-outline-dark btn-small">+</button>
                                                </form>
                                            </div>
                                            <!-- Giá -->
                                            <div class="col-md-2 col-6 text-end">
                                                <div class="item-price">@price.ToString("N0") ₫</div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Tóm tắt đơn hàng -->
                            <div class="col-md-4">
                                <div class="order-summary p-4" style="background-color: var(--light-color);">
                                    <h3 class="section-title divider mb-4">Đơn hàng</h3>
                                    @{
                                        decimal subtotal = cartItems.Sum(i => (i.BienTheSanPham?.Gia ?? 0) * i.Quantity);
                                        decimal tax = subtotal * 0.1m;
                                        decimal total = subtotal + tax;
                                    }
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Tạm tính</span>
                                        <span>@subtotal.ToString("N0") ₫</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Thuế (10%)</span>
                                        <span>@tax.ToString("N0") ₫</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3 border-top pt-3">
                                        <strong>Tổng cộng</strong>
                                        <strong>@total.ToString("N0") ₫</strong>
                                    </div>
                                    <div class="btn-wrap">
                                        <a href="/User/Checkout" class="btn btn-outline-accent btn-accent-arrow btn-full">
                                            Thanh toán <i class="icon icon-ns-arrow-right"></i>
                                        </a>
                                    </div>
                                    <div class="btn-wrap mt-3">
                                        <a href="/" class="btn btn-outline-light btn-full">
                                            Tiếp tục mua sắm
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</section>
