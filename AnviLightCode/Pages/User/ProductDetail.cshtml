@* @page
@model AnviLightCode.Pages.User.ProductDetailModel
@{
    ViewData["Title"] = Model.Product?.TenSanPham ?? "Chi tiết sản phẩm";
}

<section id="product-detail" class="py-5 my-5 leaf-pattern-overlay">
    <div class="corner-pattern-overlay"></div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                @if (Model.Product == null)
                {
                    <p>Sản phẩm không tồn tại.</p>
                }
                else
                {
                    <div class="row">
                        <!-- Hình ảnh sản phẩm -->
                        <div class="col-md-6">
                            <figure class="products-thumb">
                                <a href="#" class="image-hvr-effect">
                                    <img src="@Model.Product.HinhAnh" alt="@Model.Product.TenSanPham" class="single-image">
                                </a>
                            </figure>
                        </div>

                        <!-- Thông tin sản phẩm -->
                        <div class="col-md-6">
                            <div class="product-entry">
                                <h2 class="section-title divider">@Model.Product.TenSanPham</h2>
                                <div class="products-content">
                                    <div class="author-name">Thủ công bởi: AnviLight</div>
                                    <h3 class="item-title">Đèn thiết kế sẵn</h3>

                                    <!-- Lựa chọn kích thước -->
                                    <div class="size-selection mb-3">
                                        <label for="size"><strong>Kích thước:</strong></label>
                                        <select id="size" class="form-select">
                                            <option value="">-- Chọn kích thước --</option>
                                        </select>
                                    </div>

                                    <!-- Lựa chọn màu sắc -->
                                    <div class="color-selection mb-3">
                                        <label for="color"><strong>Màu sắc:</strong></label>
                                        <select id="color" class="form-select" disabled>
                                            <option value="">-- Chọn màu sắc --</option>
                                        </select>
                                    </div>
                                    <!-- Hiển thị số lượng -->
                                    <div id="stock-info" class="mt-2 text-success fw-bold" style="display: none;">
                                        Số hàng còn lại: <span id="stock-quantity"></span>
                                    </div>
                                    <!-- Ô chọn số lượng -->
                                    <div id="quantity-wrapper" class="mt-3" style="display: none;">
                                        <label><strong>Số lượng mua :</strong></label>
                                        <div class="input-group" style="max-width: 150px;">
                                            <button type="button" class="btn btn-outline-secondary" id="btn-decrease">-</button>
                                            <input type="number" id="quantity-input" class="form-control text-center" value="1" min="1">
                                            <button type="button" class="btn btn-outline-secondary" id="btn-increase">+</button>
                                        </div>
                                    </div>
                                    <div class="btn-wrap">
                                        <button type="button"
                                                class="btn btn-outline-accent btn-accent-arrow add-to-cart"
                                                id="add-to-cart-btn"
                                                data-product-id="@Model.Product.MaSanPham">
                                            Thêm vào giỏ hàng <i class="icon icon-ns-arrow-right"></i>
                                        </button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thông tin bổ sung -->
                    <div class="row mt-5">
                        <div class="col-md-12">
                            <div class="section-header align-center">
                                <h2 class="section-title">Thông tin bổ sung</h2>
                            </div>
                            <div class="additional-info">
                                <p>
                                    @Model.Product.MoTa
                                    Đèn lồng được chế tác thủ công với thiết kế tinh xảo, mang lại không gian ấm cúng và đậm chất truyền thống cho các dịp lễ hội như Trung Thu hoặc trang trí nhà cửa.
                                </p>
                                <ul>
                                    <li><strong>Chất liệu:</strong> Tre, vải lụa cao cấp</li>
                                    <li><strong>Kích thước:</strong> 40cm (cao) x 25cm (rộng)</li>
                                    <li><strong>Trọng lượng:</strong> 600g</li>
                                    <li><strong>Nguồn sáng:</strong> Đèn LED 3W, ánh sáng vàng ấm</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</section>
<script>
    var bienThes = @Html.Raw(Model.BienThesJson ?? "[]");

    const sizeSelect = document.getElementById('size');
    const colorSelect = document.getElementById('color');
    const stockInfo = document.getElementById('stock-info');
    const stockQuantity = document.getElementById('stock-quantity');

    const quantityWrapper = document.getElementById('quantity-wrapper');
    const quantityInput = document.getElementById('quantity-input');
    const btnDecrease = document.getElementById('btn-decrease');
    const btnIncrease = document.getElementById('btn-increase');

    let currentStock = 0;

    const addedSizeIds = new Set();
    bienThes.forEach(b => {
        if (!addedSizeIds.has(b.MaKichThuoc)) {
            addedSizeIds.add(b.MaKichThuoc);
            const option = document.createElement('option');
            option.value = b.MaKichThuoc;
            option.textContent = b.TenKichThuoc;
            sizeSelect.appendChild(option);
        }
    });

    sizeSelect.addEventListener('change', function () {
        const selectedSize = parseInt(this.value);
        colorSelect.innerHTML = '<option value="">-- Chọn màu sắc --</option>';
        stockInfo.style.display = 'none';
        quantityWrapper.style.display = 'none';

        if (!selectedSize) {
            colorSelect.disabled = true;
            return;
        }

        const filtered = bienThes.filter(b => b.MaKichThuoc === selectedSize);
        const addedColorIds = new Set();
        filtered.forEach(b => {
            if (!addedColorIds.has(b.MaMauSac)) {
                addedColorIds.add(b.MaMauSac);
                const option = document.createElement('option');
                option.value = b.MaMauSac;
                option.textContent = b.TenMauSac;
                colorSelect.appendChild(option);
            }
        });

        colorSelect.disabled = false;
    });

    colorSelect.addEventListener('change', function () {
        const selectedSize = parseInt(sizeSelect.value);
        const selectedColor = parseInt(this.value);
        stockInfo.style.display = 'none';
        quantityWrapper.style.display = 'none';

        if (selectedSize && selectedColor) {
            const variant = bienThes.find(b =>
                b.MaKichThuoc === selectedSize && b.MaMauSac === selectedColor
            );

            if (variant) {
                currentStock = variant.SoLuong;
                stockQuantity.textContent = currentStock;
                stockInfo.style.display = 'block';

                quantityInput.value = 1;
                quantityInput.max = currentStock;
                quantityWrapper.style.display = 'block';
            }
        }
    });

    // Tăng giảm số lượng
    btnDecrease.addEventListener('click', () => {
        let val = parseInt(quantityInput.value);
        if (val > 1) quantityInput.value = val - 1;
    });

    btnIncrease.addEventListener('click', () => {
        let val = parseInt(quantityInput.value);
        if (val < currentStock) quantityInput.value = val + 1;
    });

    // Đảm bảo nhập tay không vượt giới hạn
    quantityInput.addEventListener('input', () => {
        let val = parseInt(quantityInput.value);
        if (isNaN(val) || val < 1) {
            quantityInput.value = 1;
        } else if (val > currentStock) {
            quantityInput.value = currentStock;
        }
    });


    // Thêm giỏ hàng
    document.getElementById('add-to-cart-btn').addEventListener('click', function () {
    const productId = this.dataset.productId;
    const selectedSize = parseInt(sizeSelect.value);
    const selectedColor = parseInt(colorSelect.value);
    const quantity = parseInt(quantityInput.value);

    if (!selectedSize || !selectedColor) {
        alert("Vui lòng chọn đầy đủ kích thước và màu sắc.");
        return;
    }

    const variant = bienThes.find(b =>
        b.MaKichThuoc === selectedSize && b.MaMauSac === selectedColor
    );

    if (!variant) {
        alert("Không tìm thấy biến thể phù hợp.");
        return;
    }

    if (quantity > variant.SoLuong) {
        alert("Số lượng vượt quá tồn kho.");
        return;
    }

    // Gửi dữ liệu về server bằng fetch (hoặc bạn có thể dùng jQuery AJAX)
    fetch('/api/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
        },
        body: JSON.stringify({
            productId: productId,
            variantId: variant.MaBienThe,
            quantity: quantity
        })
    })
        .then(response => {
            if (response.ok) {
                alert("Đã thêm vào giỏ hàng!");
                // Có thể update giỏ hàng trên giao diện
            } else {
                alert("Thêm giỏ hàng thất bại.");
            }
        })
        .catch(err => {
            console.error("Lỗi khi thêm vào giỏ hàng:", err);
            alert("Đã xảy ra lỗi khi thêm vào giỏ.");
        });
        });
</script>



 *@
 @page
@model AnviLightCode.Pages.User.ProductDetailModel
@{
    ViewData["Title"] = Model.Product?.TenSanPham ?? "Chi tiết sản phẩm";
}

<section id="product-detail" class="py-5 my-5 leaf-pattern-overlay">
    <div class="corner-pattern-overlay"></div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                @if (Model.Product == null)
                {
                    <p>Sản phẩm không tồn tại.</p>
                }
                else
                {
                    <div class="row">
                        <!-- Hình ảnh sản phẩm -->
                        <div class="col-md-6">
                            <figure class="products-thumb">
                                <a href="#" class="image-hvr-effect">
                                    <img src="@Model.Product.HinhAnh" alt="@Model.Product.TenSanPham" class="single-image" />
                                </a>
                            </figure>
                        </div>

                        <!-- Thông tin sản phẩm -->
                        <div class="col-md-6">
                            <div class="product-entry">
                                <h2 class="section-title divider">@Model.Product.TenSanPham</h2>
                                <div class="products-content">
                                    <div class="author-name">Thủ công bởi: AnviLight</div>
                                    <h3 class="item-title">Đèn thiết kế sẵn</h3>

                                    <!-- Lựa chọn kích thước -->
                                    <div class="size-selection mb-3">
                                        <label for="size"><strong>Kích thước:</strong></label>
                                        <select id="size" class="form-select">
                                            <option value="">-- Chọn kích thước --</option>
                                        </select>
                                    </div>

                                    <!-- Lựa chọn màu sắc -->
                                    <div class="color-selection mb-3">
                                        <label for="color"><strong>Màu sắc:</strong></label>
                                        <select id="color" class="form-select" disabled>
                                            <option value="">-- Chọn màu sắc --</option>
                                        </select>
                                    </div>

                                    <!-- Hiển thị số lượng -->
                                    <div id="stock-info" class="mt-2 text-success fw-bold" style="display: none;">
                                        Số hàng còn lại: <span id="stock-quantity"></span>
                                    </div>

                                    <!-- Ô chọn số lượng -->
                                    <div id="quantity-wrapper" class="mt-3" style="display: none;">
                                        <label><strong>Số lượng mua :</strong></label>
                                        <div class="input-group" style="max-width: 150px;">
                                            <button type="button" class="btn btn-outline-secondary" id="btn-decrease">-</button>
                                            <input type="number" id="quantity-input" class="form-control text-center" value="1" min="1" />
                                            <button type="button" class="btn btn-outline-secondary" id="btn-increase">+</button>
                                        </div>
                                    </div>

                                    <div class="btn-wrap">
                                        @Html.AntiForgeryToken()
                                        <button type="button"
                                                class="btn btn-outline-accent btn-accent-arrow add-to-cart"
                                                id="add-to-cart-btn"
                                                data-product-id="@Model.Product.MaSanPham">
                                            Thêm vào giỏ hàng <i class="icon icon-ns-arrow-right"></i>
                                        </button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thông tin bổ sung -->
                    <div class="row mt-5">
                        <div class="col-md-12">
                            <div class="section-header align-center">
                                <h2 class="section-title">Thông tin bổ sung</h2>
                            </div>
                            <div class="additional-info">
                                <p>
                                    @Model.Product.MoTa
                                    Đèn lồng được chế tác thủ công với thiết kế tinh xảo, mang lại không gian ấm cúng và đậm chất truyền thống cho các dịp lễ hội như Trung Thu hoặc trang trí nhà cửa.
                                </p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</section>
<script>
    var bienThes = @Html.Raw(Model.BienThesJson ?? "[]");

    const sizeSelect = document.getElementById('size');
    const colorSelect = document.getElementById('color');
    const stockInfo = document.getElementById('stock-info');
    const stockQuantity = document.getElementById('stock-quantity');

    const quantityWrapper = document.getElementById('quantity-wrapper');
    const quantityInput = document.getElementById('quantity-input');
    const btnDecrease = document.getElementById('btn-decrease');
    const btnIncrease = document.getElementById('btn-increase');

    let currentStock = 0;

    // Load danh sách kích thước
    const addedSizeIds = new Set();
    bienThes.forEach(b => {
        if (!addedSizeIds.has(b.MaKichThuoc)) {
            addedSizeIds.add(b.MaKichThuoc);
            const option = document.createElement('option');
            option.value = b.MaKichThuoc;
            option.textContent = b.TenKichThuoc;
            sizeSelect.appendChild(option);
        }
    });

    sizeSelect.addEventListener('change', function () {
        const selectedSize = parseInt(this.value);
        colorSelect.innerHTML = '<option value="">-- Chọn màu sắc --</option>';
        stockInfo.style.display = 'none';
        quantityWrapper.style.display = 'none';

        if (!selectedSize) {
            colorSelect.disabled = true;
            return;
        }

        const filtered = bienThes.filter(b => b.MaKichThuoc === selectedSize);
        const addedColorIds = new Set();
        filtered.forEach(b => {
            if (!addedColorIds.has(b.MaMauSac)) {
                addedColorIds.add(b.MaMauSac);
                const option = document.createElement('option');
                option.value = b.MaMauSac;
                option.textContent = b.TenMauSac;
                colorSelect.appendChild(option);
            }
        });

        colorSelect.disabled = false;
    });

    colorSelect.addEventListener('change', function () {
        const selectedSize = parseInt(sizeSelect.value);
        const selectedColor = parseInt(this.value);
        stockInfo.style.display = 'none';
        quantityWrapper.style.display = 'none';

        if (selectedSize && selectedColor) {
            const variant = bienThes.find(b =>
                b.MaKichThuoc === selectedSize && b.MaMauSac === selectedColor
            );

            if (variant) {
                currentStock = variant.SoLuong;
                stockQuantity.textContent = currentStock;
                stockInfo.style.display = 'block';

                quantityInput.value = 1;
                quantityInput.max = currentStock;
                quantityWrapper.style.display = 'block';
            }
        }
    });

    // Tăng giảm số lượng
    btnDecrease.addEventListener('click', () => {
        let val = parseInt(quantityInput.value);
        if (val > 1) quantityInput.value = val - 1;
    });

    btnIncrease.addEventListener('click', () => {
        let val = parseInt(quantityInput.value);
        if (val < currentStock) quantityInput.value = val + 1;
    });

    // Đảm bảo nhập tay không vượt giới hạn
    quantityInput.addEventListener('input', () => {
        let val = parseInt(quantityInput.value);
        if (isNaN(val) || val < 1) {
            quantityInput.value = 1;
        } else if (val > currentStock) {
            quantityInput.value = currentStock;
        }
    });

    // Thêm giỏ hàng - gọi handler OnPostAddToCart
    document.getElementById('add-to-cart-btn').addEventListener('click', function () {
        const productId = this.dataset.productId;
        const selectedSize = parseInt(sizeSelect.value);
        const selectedColor = parseInt(colorSelect.value);
        const quantity = parseInt(quantityInput.value);

        if (!selectedSize || !selectedColor) {
            alert("Vui lòng chọn đầy đủ kích thước và màu sắc.");
            return;
        }

        const variant = bienThes.find(b =>
            b.MaKichThuoc === selectedSize && b.MaMauSac === selectedColor
        );

        if (!variant) {
            alert("Không tìm thấy biến thể phù hợp.");
            return;
        }

        if (quantity > variant.SoLuong) {
            alert("Số lượng vượt quá tồn kho.");
            return;
        }
        fetch('/User/Cart?handler=Cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: JSON.stringify({
                productId: productId,
                variantId: variant.MaBienTheSanPham,
                quantity: quantity
            })
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    window.location.href = "/User/Cart"; // Chuyển đến trang giỏ hàng
                } else if (result.redirect) {
                    const msgDiv = document.createElement('div');
                    msgDiv.innerText = "Bạn cần đăng nhập để thêm vào giỏ hàng.";
                    msgDiv.style.position = 'fixed';
                    msgDiv.style.top = '20px';
                    msgDiv.style.right = '20px';
                    msgDiv.style.backgroundColor = '#ffcccc';
                    msgDiv.style.padding = '15px';
                    msgDiv.style.border = '1px solid #ff8888';
                    msgDiv.style.borderRadius = '8px';
                    msgDiv.style.zIndex = '9999';
                    msgDiv.style.color = '#333';
                    document.body.appendChild(msgDiv);

                    setTimeout(() => {
                        msgDiv.remove();
                        window.location.href = result.redirect;
                    }, 3000);
                } else {
                    alert(result.message || "Thêm giỏ hàng thất bại.");
                }
            })
            .catch(err => {
                console.error("Lỗi khi thêm vào giỏ hàng:", err);
                alert("Đã xảy ra lỗi khi thêm vào giỏ.");
            });

    });

</script>
